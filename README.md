# otofu

なにもしないWeb UIフレームワーク、Tofuのチュートリアルです。
TofuはX11, Xtのプログラミングの経験を元にデザインしました。非常に古風なアーキテクチャです。

## 準備

Tofuをインストール。

```
% gem install tofu
```

または

```
% sudo gem install tofu
```

## 00

実験を進められるか確かめる実験です。

00ディレクトリに移動して、main.rbを実行してください。

```
% ruby main.rb
[2020-11-13 18:00:04] INFO  WEBrick 1.6.0
[2020-11-13 18:00:04] INFO  ruby 2.7.1 (2020-03-31) [x86_64-darwin19]
[2020-11-13 18:00:04] INFO  WEBrick::HTTPServer#start: pid=82365 port=8000
```

ブラウザで http://localhost:8000 にアクセスして、OTofuというバナーがあるか確かめてください。

### Tofuの役割

Tofuは主に三つの部品で構成されます。

- Bartender
- Session
- Div

#### Bartender

Bartenderの役割は、httpのリクエストから適切なSessionを見つけて、そのSessionにリクエストを届けることです。
リクエストに対応するSessionが存在しない場合は、新規のSessionを生成します。

BartenderはWEBrickなどとの直接的なインターフェイスです。main.rbではTofuletという部品を介して/にマウントしています。

```
tofu = Tofu::Bartender.new(OTofu::Session, 'otofu')
server.mount('/', Tofu::Tofulet, tofu)
```

#### Session

Sessionはクライアント（ブラウザごと）に生成されるオブジェクトです。Cookieに保存される識別子によって特定されます。
GUIプログラミングでいうとSessionは一つの仮想的な画面、仮想的なウィンドウのようなものです。
ログインの状態など、その画面に固有の情報を保持します。

TofuはWeb UIのみを解決するフレームワークなので、永続化などに関してはなにもしません。

#### Div

DivはHTMLの断片に相当するオブジェクトです。GUIプログラミングでのWidgetのようなものです。
Sessionは少なくとも一つのDivを持ちます。00ではBaseという土台のDivを生成しています。
DivはSessionごとに生成されます。クライアントごとにGUI部品がある、といったイメージです。
Webプログラミングのうち、画面の状態（のようなもの）に相当する情報をDivが保持します。
たとえば、現在のリスト表示は日付順ソートである、とか、値の編集中である、などの見かけの状態をDivが保持するのに適しています。

Web UIのリンクのうち、GUIの操作的なものを受け取る係でもあります。
DivはHTMLを組み立てるためのユーティリティメソッドを持っています。
この中には自身のDivに対する操作を表すリンクを生成するメソッドもあります。

### リクエストとレスポンス

TofuはGUI模したフレームワークなので、リクエスト、つまりGUI操作（状態の更新）と、レスポンス、GUIの描画とを分離して考えます。
これはWebアプリを関数と考えるケースが多いのとだいぶ異なっています。
GUI操作が連続あるいは同時に発生した場合を考えてください。
入力に対していつも同じ出力を返す関数として考えるのではなく、
さまざまな操作がなされた後の最新の状態のスナップショットを使って画面を作ると考えた方が都合がよいのです。
サーバー側に「状態」があり、複数のリクエストから状態を更新する、というのはWebアプリでは当たり前に発生することです。

- リクエストは状態を変更させる
- レスポンスは最新の状態のスナップショット（HTML）を返す

Tofuはこの2フェーズでプログラミングします。

WEBrickに届いたリクエストが処理される様子を示します。

1. BartenderはSessionを探す（「操作」がなければこれで終わり）
2. Divを探す
3. Divに操作の情報を渡す
4. 内部状態を更新する

レスポンスを組み立てる様子を示します。
すでにSessionは特定されているので、

1. Session#lookup_viewでHTMLを組み立てる土台のDivをぶ
2. Div#to_htmlでHTMLを生成

API的なサービス（レスポンスがJSONなどHTML以外のなにか）の場合でもこの原則は同じです。


## 01


